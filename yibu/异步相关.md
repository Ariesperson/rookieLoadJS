# å¼‚æ­¥(Promise)

å¼‚æ­¥åŒ…æ‹¬ï¼šfsæ–‡ä»¶æ“ä½œã€æ•°æ®åº“æ“ä½œã€Ajaxã€å®šæ—¶å™¨

## Promise

â€‹	`Promise`å¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼š`pending`ï¼ˆè¿›è¡Œä¸­ï¼‰ã€`fulfilled`ï¼ˆå·²æˆåŠŸï¼‰å’Œ`rejected`ï¼ˆå·²å¤±è´¥ï¼‰

ä¸€ä¸ª `Promise` å¿…ç„¶å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ä¹‹ä¸€ ğŸ‘‡ï¼š

- å¾…å®š `(pending)`: åˆå§‹çŠ¶æ€ï¼Œæ—¢æ²¡æœ‰è¢«å…‘ç°ï¼Œä¹Ÿæ²¡æœ‰è¢«æ‹’ç»ã€‚
- å·²æˆåŠŸ `(fulfilled)`: æ„å‘³ç€æ“ä½œæˆåŠŸå®Œæˆã€‚
- å·²æ‹’ç» `(rejected)`: æ„å‘³ç€æ“ä½œå¤±è´¥ã€‚

```javascript
let p1 = new Promise((resolve, reject) => {
    resolve('æˆåŠŸ')
    reject('å¤±è´¥')
})
console.log('p1', p1) //promiseå¯¹è±¡  PromiseState:'fulfilled' PromiseResult:'æˆåŠŸ'

let p2 = new Promise((resolve, reject) => {
    reject('å¤±è´¥')
    resolve('æˆåŠŸ')
})
console.log('p2', p2)//promiseå¯¹è±¡  PromiseState:'rejected' PromiseResult:'å¤±è´¥'

let p3 = new Promise((resolve, reject) => {
    throw('æŠ¥é”™')
})
console.log('p3', p3)//promiseå¯¹è±¡  PromiseState:'rejected' PromiseResult:'æŠ¥é”™'
```

1ã€æ‰§è¡Œäº†`resolve()`ï¼ŒPromiseçŠ¶æ€ä¼šå˜æˆ`fulfilled`ï¼Œå³ **å·²å®ŒæˆçŠ¶æ€**

2ã€æ‰§è¡Œäº†`reject()`ï¼ŒPromiseçŠ¶æ€ä¼šå˜æˆ`rejected`ï¼Œå³ **è¢«æ‹’ç»çŠ¶æ€**

3ã€Promiseåªä»¥`ç¬¬ä¸€æ¬¡ä¸ºå‡†`ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸå°±`æ°¸ä¹…`ä¸º`fulfilled`ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±æ°¸è¿œçŠ¶æ€ä¸º`rejected`

4ã€Promiseä¸­æœ‰`throw`çš„è¯ï¼Œå°±ç›¸å½“äºæ‰§è¡Œäº†`reject()`

```javascript
let myPromise1 = new Promise(() => {});

console.log('myPromise1 :>> ', myPromise1);
//promiseå¯¹è±¡  PromiseState:'pending' PromiseResult:'undefined'

let myPromise2 = new Promise((resolve, reject) => {
    let a = 1;
    for (let index = 0; index < 5; index++) {
        a++;
    }
})

console.log('myPromise2 :>> ', myPromise2) 
//promiseå¯¹è±¡  PromiseState:'pending' PromiseResult:'undefined'

myPromise2.then(() => {
    console.log("myPromise2æ‰§è¡Œäº†then");
})

```

- 1ã€Promiseçš„åˆå§‹çŠ¶æ€æ˜¯`pending`
- 2ã€Promiseé‡Œæ²¡æœ‰æ‰§è¡Œ`resolve()`ã€`reject()`ä»¥åŠ`throw`çš„è¯ï¼Œè¿™ä¸ª**promiseçš„çŠ¶æ€ä¹Ÿæ˜¯`pending`**
- 3ã€åŸºäºä¸Šä¸€æ¡ï¼Œ`pending`çŠ¶æ€ä¸‹çš„promiseä¸ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°`then()`

```javascript
let myPromise0 = new Promise();
console.log('myPromise0 :>> ', myPromise0);
// Uncaught TypeError: Promise resolver undefined is not a function
// è§„å®šå¿…é¡»ç»™Promiseå¯¹è±¡ä¼ å…¥ä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œå¦åˆ™å°†ä¼šæŠ¥é”™ã€‚
```

## å®ç°Promise

### 1.åˆ›å»ºç±»ï¼Œå®šä¹‰åˆå§‹ç»“æ„

```javascript
class myPromise {
+    constructor(func) {
+       func();
+   }
}
```

### 2.å®ç°resolveå’Œreject:

#### ç®¡ç†çŠ¶æ€å’Œç»“æœ

â€‹	çŠ¶æ€å’Œç»“æœï¼špendingã€fulfilledå’Œrejected:

- åˆå§‹çš„æ—¶å€™æ˜¯`pending`
- `pending`å¯ä»¥è½¬ä¸º`fulfilled`çŠ¶æ€ï¼Œä½†æ˜¯ä¸èƒ½é€†è½¬
- `pending`ä¹Ÿå¯ä»¥è½¬ä¸º`rejected`çŠ¶æ€ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½é€†è½¬
- è¿™é‡Œ`fulfilled`å’Œ`rejected`ä¹Ÿä¸èƒ½äº’è½¬

#### æ‰§è¡Œ resolve() å’Œ reject() å¯ä»¥ä¼ å‚

#### thisæŒ‡å‘é—®é¢˜

è°ƒç”¨`this.PromiseState `çš„æ—¶å€™å¹¶æ²¡æœ‰è°ƒç”¨`constructor`é‡Œçš„`this.PromiseState `ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„`this`å·²ç»è·Ÿä¸¢äº†~

æˆ‘ä»¬åœ¨`new`ä¸€ä¸ªæ–°å®ä¾‹çš„æ—¶å€™æ‰§è¡Œçš„æ˜¯`constructor`é‡Œçš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯`constructor`é‡Œçš„`this`ç¡®å®æ˜¯æ–°å®ä¾‹çš„ï¼Œä½†ç°åœ¨æˆ‘ä»¬æ˜¯åœ¨æ–°å®ä¾‹è¢«åˆ›å»ºåå†åœ¨å¤–éƒ¨ç¯å¢ƒä¸‹æ‰§è¡Œ`resolve()`æ–¹æ³•çš„ï¼Œè¿™é‡Œçš„`resolve()`çœ‹ç€åƒæ˜¯å’Œå®ä¾‹ä¸€èµ·æ‰§è¡Œçš„ï¼Œå…¶å®ä¸ç„¶ï¼Œä¹Ÿå°±**ç›¸å½“äºä¸åœ¨`class`å†…éƒ¨ä½¿ç”¨è¿™ä¸ª`this`**ï¼Œè€Œ**æˆ‘ä»¬æ²¡æœ‰åœ¨å¤–éƒ¨å®šä¹‰ä»»ä½•`PromiseState `å˜é‡ï¼Œå› æ­¤è¿™é‡Œä¼šæŠ¥é”™**

è§£å†³`class`çš„`this`æŒ‡å‘é—®é¢˜ä¸€èˆ¬ä¼šç”¨ç®­å¤´å‡½æ•°ï¼Œ`bind`æˆ–è€…`proxy`ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`bind`æ¥ç»‘å®š`this`ï¼Œåªéœ€è¦åœ¨æ„é€ å‡½æ•°`constructor`ä¸­çš„`this.resolve`å’Œ`this.reject`ååŠ ä¸Šï¼Œ`.bindï¼ˆthisï¼‰`å°±å¯ä»¥äº† ğŸ˜º

```javascript

class myPromise{
    static PENDING = 'pending'
    static FULFILLED = 'fulfilled'
    static REJECTED = 'rejected'
   //éœ€è¦åœ¨ç±»çš„æ„é€ å‡½æ•°constructoré‡Œé¢æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œè¿™é‡Œå°±ç”¨funcæ¥åšå½¢å‚ï¼Œå¹¶ä¸”æ‰§è¡Œä¸€ä¸‹è¿™ä¸ªå‚æ•°
    constructor(func){
        this.PromiseState = myPromise.PENDING//åˆå§‹çš„æ—¶å€™æ˜¯pendingçŠ¶æ€
        func(this.resolve.bind(this),this.reject.bind(this));;
    }
    resolve(result){
        //é‚£ä¹ˆåœ¨æ‰§è¡Œresolve()çš„æ—¶å€™å°±éœ€è¦åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸º å¾…å®š pendingï¼Œå¦‚æœæ˜¯ å¾…å®š pendingçš„è¯å°±			æŠŠçŠ¶æ€æ”¹ä¸º æˆåŠŸ fulfilled:
        if(this.PromiseState === myPromise.PENDING){
           this.PromiseState = myPromise.FULFILLED;
           // resolve()æ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„PromiseResultå±æ€§
           this.PromiseResult = result; 
        }
    }
    reject(reason){
      	//ä¸ºç»™rejectæ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„PromiseResultå±æ€§:
        if (this.PromiseState === myPromise.PENDING) {
          this.PromiseState = myPromise.REJECT;
          //ä¸ºç»™reject()æ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„PromiseResultå±æ€§
          this.PromiseResult = reason;
        }
    }
}

// æµ‹è¯•ä»£ç 1
// æµ‹è¯•ä»£ç 
let promise1 = new myPromise((resolve, reject) => {
    resolve('è¿™æ¬¡ä¸€å®š');
})
console.log(promise1); 
// myPromise {PromiseState: 'fulfilled', PromiseResult: 'è¿™æ¬¡ä¸€å®š'}
let promise2 = new myPromise((resolve, reject) => {
    reject('ä¸‹æ¬¡ä¸€å®š');
})
console.log(promise2); 
// myPromise {PromiseState: 'rejected', PromiseResult: 'ä¸‹æ¬¡ä¸€å®š'}

```

### å®ç°thenæ–¹æ³•

`then`æ–¹æ³•å¯ä»¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°

- ä¸€ä¸ªæ˜¯ `onFulfilled` è¡¨ç¤º `â€œå½“çŠ¶æ€ä¸ºæˆåŠŸæ—¶â€`
- å¦ä¸€ä¸ªæ˜¯ `onRejected` è¡¨ç¤º `â€œå½“çŠ¶æ€ä¸ºæ‹’ç»æ—¶â€`



```javascript
class myPromise{
    static PENDING = 'pending'
    static FULFILLED = 'fulfilled'
    static REJECTED = 'rejected'
   //éœ€è¦åœ¨ç±»çš„æ„é€ å‡½æ•°constructoré‡Œé¢æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œè¿™é‡Œå°±ç”¨funcæ¥åšå½¢å‚ï¼Œå¹¶ä¸”æ‰§è¡Œä¸€ä¸‹è¿™ä¸ªå‚æ•°
    constructor(func){
        this.PromiseState = myPromise.PENDING//åˆå§‹çš„æ—¶å€™æ˜¯pendingçŠ¶æ€
        func(this.resolve.bind(this),this.reject.bind(this));;
    }
    resolve(result){
        //é‚£ä¹ˆåœ¨æ‰§è¡Œresolve()çš„æ—¶å€™å°±éœ€è¦åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸º å¾…å®š pendingï¼Œå¦‚æœæ˜¯ å¾…å®š pendingçš„è¯å°±			æŠŠçŠ¶æ€æ”¹ä¸º æˆåŠŸ fulfilled:
        if(this.PromiseState === myPromise.PENDING){
           this.PromiseState = myPromise.FULFILLED;
           // resolve()æ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„PromiseResultå±æ€§
           this.PromiseResult = result; 
        }
    }
    reject(reason){
      	//ä¸ºç»™rejectæ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„PromiseResultå±æ€§:
        if (this.PromiseState === myPromise.PENDING) {
          this.PromiseState = myPromise.REJECT;
          //ä¸ºç»™reject()æ·»åŠ å‚æ•°ï¼Œå¹¶ä¸”æŠŠå‚æ•°èµ‹å€¼ç»™å®ä¾‹çš„PromiseResultå±æ€§
          this.PromiseResult = reason;
        }
    }
	then(onFulfilled,onRejected){
        if(this.PromiseState === myPromise.FULFILLED){
            onFulfilled(this.PromiseResult)
        }
            f (this.PromiseState === myPromise.REJECTED) {
           onRejected(this.PromiseResult);
      }
    }
}
```

